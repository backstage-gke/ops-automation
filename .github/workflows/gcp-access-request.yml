name: GCP Access Provisioning

on:
  workflow_dispatch:
    inputs:
      requester_email:
        description: 'User Email'
        required: true
      provider:
        description: 'Cloud Provider'
        required: true
      gcp_role:
        description: 'IAM Role'
        required: true
      designation:
        description: 'User Designation'
        required: true
      duration:
        description: 'Access Duration'
        required: true

permissions:
  contents: read
  id-token: write # Required for GCP OIDC

jobs:
  # JOB 1: SUMMARY (Runs immediately so Approver sees details)
  request-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Request Summary
        run: |
          echo "### ðŸ” Access Request Details" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Requester** | \`${{ inputs.requester_email }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Designation** | ${{ inputs.designation }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Role** | \`${{ inputs.gcp_role }}\` |" >> $GITHUB_STEP_SUMMARY
          
          # Logic to display correct duration status
          if [[ "${{ inputs.gcp_role }}" == "roles/editor" || "${{ inputs.gcp_role }}" == "roles/viewer" ]]; then
             echo "| **Duration** | â™¾ï¸ **PERMANENT** (Basic Role) |" >> $GITHUB_STEP_SUMMARY
             echo "" >> $GITHUB_STEP_SUMMARY
             echo "> âš ï¸ **Warning:** User selected a Basic Role. Time-based expiry **cannot** be applied." >> $GITHUB_STEP_SUMMARY
          else
             echo "| **Duration** | â³ ${{ inputs.duration }} |" >> $GITHUB_STEP_SUMMARY
             echo "" >> $GITHUB_STEP_SUMMARY
             echo "> âœ… **Info:** Access will automatically expire after ${{ inputs.duration }}." >> $GITHUB_STEP_SUMMARY
          fi

  # JOB 2: PROVISIONING (Pauses for Approval)
  provision-gcp:
    needs: request-summary
    if: inputs.provider == 'GCP'
    runs-on: ubuntu-latest
    
    # THIS IS THE APPROVAL GATE
    environment: production-gcp 
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------------------------------------------
      # 1. CALCULATE EXPIRATION DATE
      # ----------------------------------------------------------------
      - name: Calculate Expiry Timestamp
        id: calc_expiry
        run: |
          if [[ "${{ inputs.duration }}" == "1 Week" ]]; then
            EXPIRY=$(date -d "+1 week" +%Y-%m-%dT%H:%M:%SZ)
          elif [[ "${{ inputs.duration }}" == "1 Month" ]]; then
            EXPIRY=$(date -d "+1 month" +%Y-%m-%dT%H:%M:%SZ)
          elif [[ "${{ inputs.duration }}" == "3 Months" ]]; then
            EXPIRY=$(date -d "+3 months" +%Y-%m-%dT%H:%M:%SZ)
          else
            EXPIRY=$(date -d "+1 day" +%Y-%m-%dT%H:%M:%SZ)
          fi
          echo "expiry_ts=$EXPIRY" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------------
      # 2. AUTHENTICATE
      # ----------------------------------------------------------------
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "${{ secrets.GCP_WIF_PROVIDER }}"
          service_account: "${{ secrets.GCP_SA }}"

      # ----------------------------------------------------------------
      # 3. APPLY IAM BINDING (CONDITIONAL LOGIC)
      # ----------------------------------------------------------------
      - name: Apply IAM Binding
        run: |
          EMAIL="${{ inputs.requester_email }}"
          ROLE="${{ inputs.gcp_role }}"
          PROJECT="${{ secrets.GCP_PROJECT_ID }}"
          EXPIRY="${{ steps.calc_expiry.outputs.expiry_ts }}"
          
          echo "Processing role assignment..."

          # CHECK: If Role is Viewer or Editor -> NO CONDITION
          if [[ "$ROLE" == "roles/viewer" || "$ROLE" == "roles/editor" ]]; then
            
            echo "âš ï¸ Basic Role detected ($ROLE). applying PERMANENT access."
            
            gcloud projects add-iam-policy-binding "$PROJECT" \
              --member="user:$EMAIL" \
              --role="$ROLE"

          else
            # Predefined Role -> APPLY CONDITION
            echo "âœ… Predefined Role detected ($ROLE). Applying expiry: $EXPIRY"

            CONDITION_EXPR="request.time < timestamp(\"$EXPIRY\")"
            CONDITION_TITLE="Expires_on_${EXPIRY//:/_}"
            CONDITION_DESC="Temporary access for ${{ inputs.designation }}"

            gcloud projects add-iam-policy-binding "$PROJECT" \
              --member="user:$EMAIL" \
              --role="$ROLE" \
              --condition="expression=$CONDITION_EXPR,title=$CONDITION_TITLE,description=$CONDITION_DESC"
          fi
