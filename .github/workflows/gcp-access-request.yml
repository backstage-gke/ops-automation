name: GCP Access Provisioning

on:
  workflow_dispatch:
    inputs:
      requester_email:
        description: 'User Email'
        required: true
      provider:
        description: 'Cloud Provider'
        required: true
      gcp_role:
        description: 'IAM Role'
        required: true
      designation:
        description: 'User Designation'
        required: true
      duration:
        description: 'Access Duration'
        required: true

permissions:
  contents: read
  id-token: write # Required for GCP OIDC

jobs:
  # JOB 1: SUMMARY (Runs immediately so Approver sees details)
  request-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Request Summary
        run: |
          echo "### ðŸ” Access Request Details" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Requester** | \`${{ inputs.requester_email }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Designation** | ${{ inputs.designation }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target Cloud** | ${{ inputs.provider }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **GCP Project** | \`${{ secrets.GCP_PROJECT_ID }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Requested Role** | \`${{ inputs.gcp_role }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Duration** | â³ ${{ inputs.duration }} |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> âš ï¸ **Approver Notice:** Access will automatically expire after **${{ inputs.duration }}**." >> $GITHUB_STEP_SUMMARY

  # JOB 2: PROVISIONING (Pauses for Approval)
  provision-gcp:
    needs: request-summary
    if: inputs.provider == 'GCP'
    runs-on: ubuntu-latest
    
    # THIS IS THE APPROVAL GATE
    environment: production-gcp 
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------------------------------------------
      # 1. CALCULATE EXPIRATION DATE
      # ----------------------------------------------------------------
      - name: Calculate Expiry Timestamp
        id: calc_expiry
        run: |
          DURATION="${{ inputs.duration }}"
          
          if [[ "$DURATION" == "1 Week" ]]; then
            EXPIRY_DATE=$(date -d "+1 week" +%Y-%m-%dT%H:%M:%SZ)
          elif [[ "$DURATION" == "1 Month" ]]; then
            EXPIRY_DATE=$(date -d "+1 month" +%Y-%m-%dT%H:%M:%SZ)
          elif [[ "$DURATION" == "3 Months" ]]; then
            EXPIRY_DATE=$(date -d "+3 months" +%Y-%m-%dT%H:%M:%SZ)
          else
            # Default to 1 day if something goes wrong
            EXPIRY_DATE=$(date -d "+1 day" +%Y-%m-%dT%H:%M:%SZ)
          fi
          
          echo "Calculated Expiry: $EXPIRY_DATE"
          echo "expiry_ts=$EXPIRY_DATE" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------------
      # 2. AUTHENTICATE
      # ----------------------------------------------------------------
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "${{ secrets.GCP_WIF_PROVIDER }}"
          service_account: "${{ secrets.GCP_SA }}"

      # ----------------------------------------------------------------
      # 3. APPLY IAM BINDING WITH CONDITION
      # ----------------------------------------------------------------
      - name: Apply Conditional IAM Binding
        run: |
          EMAIL="${{ inputs.requester_email }}"
          ROLE="${{ inputs.gcp_role }}"
          PROJECT="${{ secrets.GCP_PROJECT_ID }}"
          DESIGNATION="${{ inputs.designation }}"
          EXPIRY="${{ steps.calc_expiry.outputs.expiry_ts }}"
          
          echo "Applying $ROLE to $EMAIL on $PROJECT..."
          echo "Condition: Access expires at $EXPIRY"

          # Construct the IAM Condition
          # Format: request.time < timestamp("YYYY-MM-DDThh:mm:ssZ")
          CONDITION_EXPRESSION="request.time < timestamp(\"$EXPIRY\")"
          CONDITION_TITLE="Expires_on_${EXPIRY//:/_}"
          CONDITION_DESC="Temporary access for $DESIGNATION until $EXPIRY"

          gcloud projects add-iam-policy-binding "$PROJECT" \
            --member="user:$EMAIL" \
            --role="$ROLE" \
            --condition="expression=$CONDITION_EXPRESSION,title=$CONDITION_TITLE,description=$CONDITION_DESC"
